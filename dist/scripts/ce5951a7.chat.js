/*! chat-demo 2013-10-31 */
(function(){var a,b,c,d,e;$win=$(window),$body=$("body"),$users_list=$("#users_list"),$chat_msg_container=$("#chat-msg-container"),b=io.connect(),a=$.cookie("user"),c="",e=doT.template('<img width="50" height="50" class="img-rounded" src="images/default-50.gif" alt="placeholder+image" style=""><div class="cont" ><div class="ops"><a href="#" class="skanHistory" data-user-to="{{=it.screen_name}}">聊天记录</a></div><p class="screen_name" ng-model="screen_name_to">{{=it.screen_name}}</p><p class="desc">{{=it.description}}</p></div>'),d=doT.template('{{? !it.sysInfo }}<li class="{{=it.self ? "self" : ""}}"><div class="cont"><h3><span class="screen_name">{{=it.screen_name}}</span><span class="time">{{=it.date}}</span></h3><p>{{=it.msg}}</p></div></li>{{??}}<li class="sysInfo"><p class="cont">{{=it.msg}} <span class="time">{{=it.date}}</span></p></li>{{?}}'),PEM.chat={flushUsers:function(b){b=_.filter(b,function(b){return b.name!==a});var d=$("<ul></ul>");_.forEach(b,function(a){d.append('<li data-user="'+a.name+'" class="online"><a href="javascript:;"><img width="30" height="30" class="img-rounded" src="images/default-30.gif" alt="placeholder+image"> '+a.name+' <span class="badge pull-right" style="display:none"></span></a></li>')}),d.find("li:first").addClass("first"),d.find("li:last").addClass("last"),c&&d.find("li[data-user='"+c+"']").addClass("active"),$users_list.html(d.html())},initChatPanel:function(a){var b=$("<div></div>");for(var c in a)b.append("<ul class='contents' style='display:none' id='contents_"+a[c].name+"'></ul>");$(".chat-msg-panel").html(b.html())},showSayTo:function(){$("#from").html(a),$("#to").html(c),$("#from").parent().css("visibility","visible")},renderProfile:function(a){var b=$("#profile_to");b.html(e({screen_name:a.to,description:"description here"}))},appendChatMsg:function(b){var e=b.from===a?c:b.from,f=$(".chat-msg-panel"),g=f.find("#contents_"+e);g.append(d({sysInfo:b.sysInfo||!1,self:b.from===a,screen_name:b.from,date:PEM.helper.now(),msg:b.msg})),PEM.util.scrollTop(f,g.height())},skanHistory:function(b){var c,e=$(".chat-msg-history"),f=$("<ul></ul>");$.getJSON("/history/"+b.to,function(g){_.forEach(g,function(b){f.append(d({sysInfo:b.sysInfo||!1,self:b.from===a,screen_name:b.from,date:b.date,msg:b.msg}))}),$("ul.users_list").find(".active").removeClass("active"),c=f.before($('<p class="header">以下是你与<span class="to"></span>的聊天记录，<a href="javascript:;" class="">返回聊天</a></p>').find(".to").text(b.to).end().find("a").click(function(a){console.log(344),a.preventDefault(),$("ul.users_list").find("li[data-user='"+b.to+"']").click()}).end()),e.html(c).show().siblings(".chat-msg-content").hide()})},updateUnread:function(a){var b=$users_list.find("li[data-user='"+a.from+"']");if(!b.hasClass("active")){var c=b.find(".badge"),d=c.text()||0;c.text(++d).show()}},bindEvent:function(){$users_list.on("click","li",function(a){a.preventDefault();var b,d=$(this);$(".chat-msg-content");var e=$(".chat-msg-panel");c=d.attr("data-user"),b=$("#contents_"+c),d.addClass("active").siblings("li").removeClass("active"),d.find(".badge").text("").hide(),PEM.chat.showSayTo(),PEM.chat.renderProfile({to:c}),$chat_msg_container.show().find(".chat-msg-content").show().siblings().hide().end(),b.show().siblings("ul.contents").hide(),$("form#chatForm").find("input[type='text']").focus(),PEM.util.scrollTop(e,b.height())}),$chat_msg_container.on("click",".skanHistory",function(b){b.preventDefault();var c=$(this),d=a,e=c.attr("data-user-to");PEM.chat.skanHistory({to:e,from:d})}),$("form#chatForm").submit(function(d){d.preventDefault();var e=$(this),f=e.find("input[type='text']"),g=f.val();return""===$.trim(g)?f.focus():(PEM.chat.appendChatMsg({from:a,msg:g,to:c}),b.emit("say",{from:a,to:c,msg:g}),f.val("").focus(),void 0)}),$(window).bind("beforeunload",function(){})},bindSocket:function(){b.emit("online",{user:a});var d=!0;b.on("online",function(b){if(PEM.chat.flushUsers(b.users),b.user===c&&PEM.chat.appendChatMsg({sysInfo:!0,from:a,msg:"系统消息：用户"+b.user+"上线了",to:c}),d)PEM.chat.initChatPanel(b.users),d=!1;else{var e=$(".chat-msg-panel");e.findOrAppend("#contents_"+b.user,"<ul class='contents' style='display:none' id='contents_"+b.user+"'></ul>",function(){})}}),b.on("say",function(a){PEM.chat.appendChatMsg({from:a.from,msg:a.msg,to:a.to}),PEM.chat.updateUnread(a)}),b.on("offline",function(b){b.user===c&&PEM.chat.appendChatMsg({sysInfo:!0,from:a,msg:"系统消息：用户"+b.user+"下线了",to:c}),PEM.chat.flushUsers(b.users)})},init:function(){PEM.util.init(),PEM.chat.bindEvent(),PEM.chat.bindSocket()}},PEM.chat.init()}).call(this);